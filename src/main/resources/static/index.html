<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>CMS</title>
    <script src="js/jquery-1.11.0.min.js" type="text/javascript"></script>
    <script src="js/megamenu.js" type="text/javascript"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 你的现有样式保持不变 */
        .week-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .week-display {
            margin: 0 20px;
            font-size: 18px;
            font-weight: bold;
            min-width: 300px;
            text-align: center;
        }
        
        .nav-button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .nav-button:hover {
            background: #0056b3;
        }
        
        .nav-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .week-days {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .day {
            flex: 1;
            text-align: center;
            padding: 15px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        
        .day.weekend {
            background: #ffe6e6;
            color: #cc0000;
        }
        
        .date {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .day-name {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="main_menu" class="menu-container"></div>
    <div class="week-navigation">
        <button id="prevWeek" class="nav-button">上一周</button>
        <div id="weekDisplay" class="week-display"></div>
        <button id="nextWeek" class="nav-button">下一周</button>
        <!-- <button id="currentWeek" class="nav-button">回到今天</button> -->
    </div>
    <!-- <div id="weekCalendar" class="week-days"></div> -->

    <!-- 新增课程表容器 -->
    <div class="timetable-container">
        <div id="courseTimetable" class="timetable">
            <!-- 课程表将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 然后按正确顺序引入组件 -->
    <script src="js/common-utils.js" type="text/javascript"></script>
    <script src="js/week-navigation.js" type="text/javascript"></script>
    <script src="js/course-timetable.js" type="text/javascript"></script>
    <script src="js/setcommon.js" type="text/javascript"></script>

    <!-- 最后初始化应用 -->
    <script>
        // 课程数据
        let courseData = {};
        window.onload = function() {
            $.ajax({
                type:"GET",
                url:"http://localhost:8083/course/getCoursesByDate",
                contentType:"application/x-www-form-urlencoded",
                data:{
                    "startDate": window.weekNavigation.getCurrentWeekInfo().weekDays[0].formattedDate,
                    "endDate": window.weekNavigation.getCurrentWeekInfo().weekDays[6].formattedDate,
                },
                xhrFields:{withCredentials:true},
                success:function(data){
                    if (data.status=="success") {
                        courseData = data;
                        window.courseTimetable.setCourseData(courseData);
                    }else{
                        alert("数据加载失败，因为 "+data.responseText);
                    }
                },
                error:function(data){
                    alert("数据加载失败，因为 "+data.responseText);
                }
            });
        }
        // 等待所有组件加载完成
        window.addEventListener('load', function() {
            console.log('页面完全加载完成，开始初始化应用...');
            
            // 添加调试信息
            console.log('window.weekNavigation:', window.weekNavigation);
            console.log('window.courseTimetable:', window.courseTimetable);
            
            // 安全初始化函数
            function safeInitializeApp() {
                let attempts = 0;
                const maxAttempts = 50;
                
                function tryInitialize() {
                    attempts++;
                    
                    // 检查组件是否已初始化
                    if (window.courseTimetable && typeof window.courseTimetable.setCourseData === 'function' &&
                        window.weekNavigation && typeof window.weekNavigation.getCurrentWeekInfo === 'function') {
                        
                        console.log('所有组件已初始化成功，开始设置数据');
                        
                        // 设置课程数据
                        window.courseTimetable.setCourseData(courseData);

                        // 设置当前周的日期
                        const currentWeek = window.weekNavigation.getCurrentWeekInfo();
                        window.courseTimetable.setCurrentWeekDays(currentWeek.weekDays);
                        
                        console.log('应用初始化完成！');
                        
                    } else if (attempts < maxAttempts) {
                        console.log(`组件初始化中... 尝试 ${attempts}/${maxAttempts}`);
                        setTimeout(tryInitialize, 100);
                    } else {
                        console.error('组件初始化失败！');
                        console.log('当前状态:');
                        console.log('- courseTimetable:', window.courseTimetable);
                        console.log('- weekNavigation:', window.weekNavigation);
                    }
                }
                
                tryInitialize();
            }
            
            // 开始初始化
            safeInitializeApp();
        });
    </script>
</body>
</html>